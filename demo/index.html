<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå·èººå¹³åŸå¸‚å¯è§†åŒ– Demo</title>
    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        .info-window {
            padding: 10px;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            min-width: 200px;
        }
        .info-window h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .info-window p {
            margin: 5px 0;
            font-size: 13px;
            color: #666;
        }
        .info-window .highlight {
            color: #ff6b6b;
            font-weight: bold;
        }

        .custom-marker {
            background-color: #1e88e5;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        .modal-header {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            color: #333;
        }
        .detail-row {
            display: flex;
            padding: 8px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .detail-label {
            width: 120px;
            color: #666;
            font-weight: 500;
            flex-shrink: 0;
        }
        .detail-value {
            color: #333;
            word-break: break-all;
        }
        .btn-detail {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 12px;
            background-color: #f0f9ff;
            color: #1e88e5;
            border: 1px solid #1e88e5;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-decoration: none;
        }
        .btn-detail:hover {
            background-color: #e1f5fe;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="loading" class="loading">æ­£åœ¨åŠ è½½åœ°å›¾æ•°æ®...</div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDetails()">Ã—</span>
            <div class="modal-header">
                <h2 id="modalTitle">åŸå¸‚è¯¦æƒ…</h2>
            </div>
            <div id="modalBody">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <script type="text/javascript">
        let map; // Declare map globally
        let geocoder;
        let weather; // Weather service
        let locationMarker;
        let allCitiesData = []; // Store all data for access

        // Helper to update status
        function updateStatus(msg) {
            console.log(msg);
            const el = document.getElementById('loading');
            if(el) el.textContent = msg;
        }

        // 1. åˆå§‹åŒ–åœ°å›¾é…ç½®
        async function init() {
            try {
                updateStatus('æ­£åœ¨è·å–é…ç½®...');
                // Fetch config from server
                const configRes = await fetch('/api/config');
                const config = await configRes.json();
                
                if (!config.amapKey) {
                    alert('æœªæ£€æµ‹åˆ°é«˜å¾·åœ°å›¾ API Keyï¼Œè¯·æ£€æŸ¥ .env æ–‡ä»¶');
                    return;
                }

                updateStatus('æ­£åœ¨åŠ è½½é«˜å¾·åœ°å›¾è„šæœ¬...');

                // Set security config
                window._AMapSecurityConfig = {
                    securityJsCode: config.amapSecurityCode,
                };

                // Load AMap script with Geocoder and Weather plugins
                const script = document.createElement('script');
                script.src = `https://webapi.amap.com/maps?v=2.0&key=${config.amapKey}&plugin=AMap.Geocoder,AMap.Weather`;
                script.onload = () => {
                    updateStatus('è„šæœ¬åŠ è½½å®Œæˆï¼Œæ­£åœ¨åˆå§‹åŒ–åœ°å›¾...');
                    loadMap();
                };
                script.onerror = (e) => {
                    console.error('Script load error:', e);
                    updateStatus('é«˜å¾·åœ°å›¾è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Keyæ˜¯å¦æ­£ç¡®');
                };
                document.head.appendChild(script);

            } catch (error) {
                console.error('Failed to initialize:', error);
                updateStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // 2. åŠ è½½åœ°å›¾å’Œæ•°æ®
        function loadMap() {
            try {
                if (typeof AMap === 'undefined') {
                    throw new Error('AMap å¯¹è±¡æœªå®šä¹‰ï¼Œè„šæœ¬å¯èƒ½åŠ è½½å¤±è´¥');
                }

                map = new AMap.Map('container', {
                    zoom: 4.5,
                    center: [108.940174, 34.341568], // Center of China roughly
                    viewMode: '2D'
                });
                
                // Map load complete event
                map.on('complete', () => {
                    console.log('Map loaded successfully');
                });

                // Initialize Geocoder and Weather
                geocoder = new AMap.Geocoder();
                weather = new AMap.Weather();

                updateStatus('æ­£åœ¨è·å–åŸå¸‚æ•°æ®...');

                // Fetch city data
                fetch('/api/cities')
                    .then(res => res.json())
                    .then(cities => {
                        if (cities.error) {
                            throw new Error(cities.error);
                        }
                        
                        allCitiesData = cities; // Store globally
                        
                        document.getElementById('loading').style.display = 'none';
                        const infoWindow = new AMap.InfoWindow({
                            offset: new AMap.Pixel(0, -30)
                        });

                        cities.forEach((city, index) => {
                            if (!city.lat || !city.lng) return;

                            const marker = new AMap.Marker({
                                position: [city.lng, city.lat],
                                title: city.name,
                                content: `<div class="custom-marker">${city.rank || '?'}</div>`,
                                offset: new AMap.Pixel(-12, -12),
                                map: map
                            });

                            marker.on('click', () => {
                                const content = `
                                    <div class="info-window">
                                        <h3>${city.name} <small>(${city.province})</small></h3>
                                        <p>ğŸ“ åŒºåŸŸ: <span class="highlight" style="cursor: pointer; text-decoration: underline; color: #1e88e5;" onclick="window.locateDetail('${city.province}${city.name}${city.district || ''}')" title="ç‚¹å‡»å®šä½è¯¦ç»†åœ°å€">${city.province}/${city.name}${city.district ? '/' + city.district : ''}</span></p>
                                        <p>ğŸ† æ’å: <span class="highlight">${city.rank || 'N/A'}</span></p>
                                        <p>ğŸ’° æˆ¿ä»·: <span class="highlight">${city.price ? (city.price / 10000).toFixed(1) + 'ä¸‡å…ƒ' : 'æš‚æ— æ•°æ®'}</span></p>
                                        <p>ğŸŒ¤ï¸ ä»Šæ—¥æ°”æ¸©: <span id="weather-temp-range-${index}" style="color: #666;">åŠ è½½ä¸­...</span></p>
                                        <p>ğŸŒ¡ï¸ èˆ’é€‚å¤©æ•°: ${city.comfort_days || '-'} å¤©</p>
                                        <p>ğŸŒ³ ç»¿åŒ–ç‡: ${city.green_rate ? city.green_rate + '%' : '-'}</p>
                                        <button class="btn-detail" onclick="window.showDetails(${index})">æŸ¥çœ‹å®Œæ•´è¯¦æƒ…</button>
                                    </div>
                                `;
                                infoWindow.setContent(content);
                                infoWindow.open(map, marker.getPosition());
                                
                                // Fetch weather
                                if (weather) {
                                    weather.getForecast(city.name, (err, data) => {
                                        const el = document.getElementById(`weather-temp-range-${index}`);
                                        if (!el) return;

                                        if (err) {
                                            el.textContent = 'æŸ¥è¯¢å¤±è´¥';
                                            return;
                                        }
                                        if (data && data.forecasts && data.forecasts.length) {
                                            const today = data.forecasts[0];
                                            // Format: Low ~ High
                                            el.textContent = `${today.nightTemp}â„ƒ ~ ${today.dayTemp}â„ƒ`;
                                            el.className = 'highlight'; 
                                            el.style.color = ''; // Remove gray color
                                        } else {
                                            el.textContent = 'æš‚æ— æ•°æ®';
                                        }
                                    });
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.error('Error loading data:', err);
                        updateStatus('æ•°æ®åŠ è½½å¤±è´¥: ' + err.message);
                    });

            } catch (err) {
                console.error('Map init error:', err);
                updateStatus('åœ°å›¾åˆå§‹åŒ–å¤±è´¥: ' + err.message);
            }
        }


        // 3. Locate detailed address
        window.locateDetail = function(address) {
            // ... existing code ...
            if (!geocoder) return;

            document.getElementById('loading').textContent = 'æ­£åœ¨è§£æåœ°å€...';
            document.getElementById('loading').style.display = 'block';

            geocoder.getLocation(address, function(status, result) {
                document.getElementById('loading').style.display = 'none';

                if (status === 'complete' && result.geocodes.length) {
                    const lnglat = result.geocodes[0].location;
                    
                    if (locationMarker) {
                        map.remove(locationMarker);
                    }

                    locationMarker = new AMap.Marker({
                        position: lnglat,
                        map: map,
                        icon: new AMap.Icon({
                            size: new AMap.Size(25, 34),
                            image: '//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png',
                            imageSize: new AMap.Size(25, 34)
                        }),
                        offset: new AMap.Pixel(-13, -30)
                    });

                    // Add a label to indicate precise location
                    locationMarker.setLabel({
                        offset: new AMap.Pixel(0, 30), 
                        content: `<div style="background-color: white; border: 1px solid #ccc; padding: 2px 5px; border-radius: 3px; font-size: 12px;">ç²¾å‡†å®šä½</div>`,
                        direction: 'center'
                    });

                    map.setFitView([locationMarker], false, [60, 60, 60, 60], 12);
                    console.log(`Located ${address} at`, lnglat);
                } else {
                    alert('æŠ±æ­‰ï¼Œæœªèƒ½è§£æåˆ°è¯¥åœ°å€çš„ç²¾ç¡®ä½ç½®');
                    console.error('Geocode failed:', status, result);
                }
            });
        };

        // 4. Show Details Modal
        window.showDetails = function(index) {
            const city = allCitiesData[index];
            if (!city || !city.raw) return;

            document.getElementById('modalTitle').textContent = `${city.name} - è¯¦ç»†ä¿¡æ¯`;
            
            const raw = city.raw;
            let html = '';
            
            // Define keys to skip or order
            const skipKeys = ['èººå¹³åŸå¸‚ID', 'åŸå¸‚ä»£ç ', 'çœä»½ä»£ç ', 'id', 'cityId', 'provinceId', 'createdAt', 'updatedAt'];
            
            Object.keys(raw).forEach(key => {
                const value = raw[key];
                // Skip empty values, nulls, "-", "/", or internal IDs
                if (value === null || value === '' || value === undefined || value === '-' || value === '/' || skipKeys.includes(key)) return;

                html += `
                    <div class="detail-row">
                        <div class="detail-label">${key}</div>
                        <div class="detail-value">${value}</div>
                    </div>
                `;
            });

            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('detailsModal').style.display = 'flex';
        };

        window.closeDetails = function() {
            document.getElementById('detailsModal').style.display = 'none';
        };

        // Close modal when clicking outside
        document.getElementById('detailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDetails();
            }
        });

        init();
    </script>
</body>
</html>
