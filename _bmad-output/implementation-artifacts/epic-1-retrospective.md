# Epic 1 Retrospective：MVP 核心闭环（数据 → 地图 → 详情 → 探索/对比）

Status: drafted

## 目标回顾（Epic Objective）

- 在本地 SQLite 数据库基础上，完成“城市列表可查 → 地图点位可看 → 城市分维度信息可读 → 可筛选/排序/对比 → 数据可维护”的最小闭环。

## MVP 口径守护（必须持续保持一致）

- 不引入天气/新闻等动态数据（Phase 2 Backlog）。
- 不提供“综合总分/综合排名/综合躺平指数”。
  - 若数据源里存在 `rank`（或视图字段“排名”），仅按“数据源字段/顺序号”理解，避免对外承诺“综合排名能力”。

## 当前可开发资产（已产出 Story 列表）

- `1-1-data-layer-city-list`
- `1-2-map-city-points`
- `1-3-city-details-dimensions`
- `1-4-filter-sort-single-metric`
- `1-5-compare-cities`
- `1-6-data-maintenance`

## 推荐交付顺序（最小返工路径）

1. **1-1 数据层可用**
   - 目标：`/api/cities` 稳定返回 `name/lng/lat`（至少 10 条）
2. **1-2 地图点位 + 点击**
   - 目标：地图可见 marker；点击能打开详情容器（最少显示城市名）
3. **1-3 城市详情（分维度）**
   - 目标：精选 5-10 个字段（优先顶层字段，不够再用 `raw`），空值兜底
4. **1-4 筛选与单指标排序**
   - 目标：至少 3 个筛选条件 + 2 个单指标排序；排序结果可感知（Top N/列表）
5. **1-5 城市对比（2-4 城）**
   - 目标：表格对比优先；2 城起，4 城封顶；缺失字段不崩溃
6. **1-6 数据维护入口（脚本优先）**
   - 目标：写入 DB → 刷新 `/api/cities` 可见变更；只有改视图定义才重建 views

## 关键风险清单（以及建议应对）

### 风险 1：demo 与 MVP 口径冲突（天气/动态数据）

- 现状：`demo/index.html` 里 marker click 会触发 `AMap.Weather().getForecast(...)`。
- 风险：与“动态数据 Phase 2”口径冲突，且会引入 Key/网络不稳定导致的用户误报。
- 建议：
  - MVP 阶段直接移除/禁用天气调用；保留静态字段展示。

### 风险 2：`rank` 被误读为综合排名

- 现状：demo marker 上展示 `rank`，infoWindow 中也展示“🏆 排名”。
- 风险：用户/开发者会把它理解成产品能力（综合排名），与 MVP 决策冲突。
- 建议：
  - MVP UI 中不突出 `rank`，或替换文案为“数据源序号/数据源顺序”。
  - Story/验收层明确：不对外承诺“综合排名能力”。

### 风险 3：环境分裂（写入 DB 与 demo 读取 DB 不是同一个文件）

- 现状：demo 固定读取 `data/gapmap.db`；Prisma 写入依赖 `.env` 的 `DATABASE_URL`。
- 风险：导入/修复脚本写到 A 库，demo 读 B 库，造成“明明更新了但前台没变化”的假问题。
- 建议：
  - 统一 `DATABASE_URL="file:./data/gapmap.db"`。

### 风险 4：字段口径/单位不一致（尤其房价）

- 现状：`/api/cities` 的 `price` 来源可能是“元/㎡”或“元/套房”，demo 里又做了 `/ 10000` 的换算。
- 风险：展示被误解；筛选/排序不可信；对比误导。
- 建议：
  - MVP 先不强行统一换算；在 UI 标注单位或按原字段语义显示。
  - 在 1-6 数据维护中逐步修复数据口径（例如使用 `fix-data.ts` 的启发式修复）。

## 最小验证路径（你可以直接照抄执行）

- **验证 1（数据层）**：`GET /api/cities` 返回 >= 10 条且 `lng/lat` 可解析。
- **验证 2（地图）**：地图加载、marker 可见、点击打开详情。
- **验证 3（详情）**：详情展示 >= 5 个字段，缺失值不崩溃。
- **验证 4（筛选/排序）**：筛选改变 marker 数量；排序 Top N 顺序可感知且稳定。
- **验证 5（对比）**：2 城起，4 城封顶；表格维度对齐；缺失字段显示 `-`。
- **验证 6（维护）**：脚本写入 DB 后，刷新 `/api/cities` 可见字段变化；只改 `views.sql` 时才重建视图。

## Dev Agent Record

### Agent Model Used

Cascade
