# Gap-map 项目改造方案 - 完整文档

## 📋 目录
1. [改造概述](#改造概述)
2. [阶段 1：类型定义](#阶段-1类型定义)
3. [阶段 2：API 客户端](#阶段-2api-客户端)
4. [阶段 3：数据访问层](#阶段-3数据访问层)
5. [阶段 4：页面数据加载](#阶段-4页面数据加载)
6. [阶段 5：API 路由优化](#阶段-5api-路由优化)
7. [阶段 6：组件重构](#阶段-6组件重构)
8. [文件清单](#文件清单)
9. [验证检查表](#验证检查表)

---

## 改造概述

### 目标
按照**大型项目的规范标准**重构 Gap-map，虽然项目规模较小。

### 核心改进
- ✅ 完整的类型定义系统（前后端共享，已按两层拆分：`CityPoint` / `City`）
- ✅ 统一的 API 请求封装（API client）
- ✅ Repository 数据访问层分离
- ⏳ 服务端数据加载（+page.server.ts，计划中）
- 🟠 清晰的三层架构（已落地 API Layer → Data Access；Business Logic 层可按需要补齐）

### 预期收益
| 指标 | 改造前 | 改造后 |
|-----|-------|-------|
| **类型覆盖率** | 30% | 100% |
| **代码复用性** | 低 | 高 |
| **维护成本** | 高 | 低 |
| **测试难度** | 难 | 容易 |
| **扩展难度** | 难 | 容易 |

### 实施周期
- **总耗时**：约 1-2 小时
- **分步进行**：可按阶段逐步实施
- **无破坏性**：可保留原代码，逐步迁移

### 当前进度（截至 2025-12-30）

- ✅ 阶段 1-3 已完成
- ✅ 阶段 5 部分完成（`/api/cities`、`/api/config`）
- ✅ 可选阶段：地图页已接入 `citiesAPI().list()`
- ⏳ 阶段 4/6 未开始

---

## 阶段 1：类型定义

### 📂 文件：src/lib/types/index.ts

**目的**：定义前后端共享的所有类型，提供类型安全和 IDE 智能提示

**内容（当前仓库最小实现）**：

```typescript
/**
 * src/lib/types/index.ts
 * Gap-map 类型定义
 * 前后端共享的接口和类型
 */

// ============================================================
// API 响应相关
// ============================================================

export interface ApiError {
  error: string;
  status?: number;
}

// ============================================================
// 应用配置相关类型
// ============================================================

/**
 * 应用配置
 * 包含第三方服务的 API Key 等
 */
export interface AppConfig {
  amapKey: string;           // 高德地图 API Key
  amapSecurityCode: string;  // 高德地图安全码
}

// ============================================================
// 城市相关类型
// ============================================================

/**
 * 地图点位最小字段（MVP）。
 * 仅用于 Marker 渲染等场景。
 */
export interface CityPoint {
  id: string;
  name: string;
  lat: number;
  lng: number;
}

/**
 * 城市完整字段（可用于详情页/筛选等）。
 * 注意：很多字段来自数据源，可能为 null。
 */
export interface City {
  id: string;
  name: string;
  province: string | null;
  rank: number | null;
  lat: number | null;
  lng: number | null;
  district: string | null;
  price: number | null;
  comfort_days: number | null;
  green_rate: number | null;
}

// ============================================================
// 页面数据类型
// ============================================================

/**
 * 首页的页面数据（来自 +page.server.ts 的 load 函数）
 * 该数据在页面加载前就已在服务端准备好
 */
export interface HomePageData {
  config: AppConfig;
  cities: City[];
}
```